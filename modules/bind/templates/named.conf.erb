# AUTOGENERATED BY PUPPET
# All manual changes will be overwritten
#
# Puppet generated configuration file
# See the named.conf(5) manpage for details

<% if @role == 'resolver' -%>
acl clients {
<% if @networks.empty? -%>
    localhost;
<% else -%>
    localhost;
<% @networks.each do |network| -%>
    <%= network -%>;
<% end -%>
<% end -%>
};
<% end -%>
acl trusted-clients {
    localhost;
    10.0.0.0/16;        # access-mgmt
    10.32.0.0/21;       # dist-mgmt
    10.32.16.0/20;      # srv-pods
    172.16.0.0/24;      # ilonet
    77.80.220.128/26;   # tech-wlan
    77.80.228.128/25;   # tech-net, tech-vpn
    77.80.228.0/26;     # tech-srv-a
    77.80.229.192/26;   # k8s-node
    77.80.231.0/24;     # tech-servers
    77.80.254.0/23;     # tech-colo
    185.42.136.171/32;  # sto2-mgmt nat
};

options {
    version "Bring me a shrubbery!";

<% if @operatingsystem == 'Debian' -%>
    directory       "/var/cache/bind";
<% end -%>
    dump-file       "<%= @dump_dir_cfg %>/named_dump.db";
    statistics-file "<%= @stats_dir_cfg %>/named.stats";

    listen-on    { any; };
    listen-on-v6 { any; };

<% if @role == 'resolver' -%>
    # Validate DNSSEC signatures.
    dnssec-validation auto;
<% if @operatingsystem == 'OpenBSD' -%>
    managed-keys-directory "managed-keys";
<% end -%>
<% end -%>

<% if @role == 'resolver' -%>
    # Do not leak any recursive queries to the root servers
    # This is the default, but should remove the following warning:
    # named[6086]: Warning: 'empty-zones-enable/disable-empty-zone' not set: disabling RFC 1918 empty zones
    empty-zones-enable yes;
    allow-recursion { clients; };
    allow-query { clients; };
<% else -%>
    allow-recursion { 127.0.0.1; 77.80.231.64/27; 77.80.254.0/24; ::1; 2a02:4b00:1337::/48; 77.80.255.0/24; 2a05:2240:5000::/48; };
<% end -%>

<% if @role == 'resolver' -%>
    allow-transfer{ none ;};
<% else -%>
    allow-transfer {
<% if @allow_transfer.empty? -%>
        localhost;
<% else -%>
<% @allow_transfer.each do |acl| -%>
        <%= acl %>
<% end -%>
<% end -%>
    };
<% end -%>
};
<% if @role == 'resolver' -%>

logging {
    category lame-servers {null;};
    category client {null;};

    channel syslog {
        syslog daemon;
        print-time yes;
        print-category yes;
        print-severity yes;
        severity warning;
    };
category default { syslog; };
};

zone "localhost" {
    type master;
    file "<%= @standard_zone_cfg %>/db.local";
    allow-transfer { localhost; };
};

zone "127.in-addr.arpa" {
    type master;
    file "<%= @standard_zone_cfg %>/db.127";
    allow-transfer { localhost; };
};

zone "0.in-addr.arpa" {
    type master;
    file "<%= @standard_zone_cfg %>/db.0";
    allow-transfer { localhost; };
};

zone "255.in-addr.arpa" {
    type master;
    file "<%= @standard_zone_cfg %>/db.255";
    allow-transfer { localhost; };
};

zone "1.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.ip6.arpa" {
    type master;
    file "<%= @standard_zone_cfg %>/db.loopback6.arpa";
    allow-transfer { localhost; };
};

#view "GAME-CSGO-PLAYERNET" {
#    match-clients { 10.32.20.0/24; };
#    zone "example.com" {
#        type master;
#        file "<%= @standard_zone_cfg %>/db.GAME-CSGO-PLAYERNET_";
#    };
#};
<% end -%>

<% if @role == 'master' -%>
include "<%= @conf_cfg %>/named.conf.master";
<% end -%>
<% if @role == 'resolver' -%>
# Resolvers slave zones for redundancy
<% end -%>
include "<%= @conf_cfg %>/named.conf.slave";
