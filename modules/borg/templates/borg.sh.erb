#!/bin/bash
# AUTOGENERATED BY PUPPET
# All manual changes will be overwritten

export BORG_RSH='ssh -i /etc/ssh/ssh_host_ecdsa_key'
export BORG_REPO=borg@storage1.tech.dreamhack.se:repository/$(hostname -f)
read -r BORG_PASSPHRASE </etc/borg.passphrase
export BORG_PASSPHRASE

# Do not backup all machines at the same time
if [[ "$1" != "--now" ]]; then
  sleep $((RANDOM / 5))
fi

borg init --encryption=repokey &> /dev/null

borg create \
  --compression lzma,3 \
  --exclude-caches \
  --exclude-from /etc/borg.exclude \
  ::'{fqdn}-{utcnow}' \
  /etc /var /srv /opt 2>&1 \
  | grep -v '^Remote:'

borg prune \
  --prefix '{fqdn}-' \
  --keep-daily 7 --keep-weekly 4 --keep-monthly 6 2>&1 \
  | grep -v '^Remote:'
